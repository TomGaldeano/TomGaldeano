{% include "links.html" %}

    <style>
        td {

            min-width: 50px;
            min-height: 50px;
            height: 50px;
            width: 50px;
            border: 1px solid var(--black);
            text-align: center;
            font-size: 1.5rem;
        }
        div {
            text-align: center;
            align-items: center;
        }
        #tablero div{
            width:150px;
            margin: 0 auto;
        }
        #tablero{
            display: flex;
            align-items: center;
        }

        .posible_move:hover {
            background-color: var(--grey);
            color: var(--blue);
        }
        .grid-container {
            display: grid;
            grid-template-columns: 10% 80% 10%;
            width: 100vw;
        }
        button{
            border-radius: 20px;
            padding: 5px;
            background-color:var(--grey);
            color: var(--black);
        }
        div:has(button){
            padding: 10px;
        }
        button:focus, button:hover, button:focus-visible{
            background-color: var(--green);
            color: var(--white);
        }
    </style>
{% include "header.html" %}
    <div id="content" class="grid-container">
        <div></div>
        <div>
        <div>
        <h1>Tres en raya</h1>
        </div>
        <div id="tablero">
        <div>
        <table>
            <tr>
                <td id="pos0">

                </td>
                <td id="pos1">

                </td>
                <td id="pos2">

                </td>
            </tr>
            <tr>
                <td id="pos3">

                </td>
                <td id="pos4">

                </td>
                <td id="pos5">

                </td>
            </tr>
            <tr>
                <td id="pos6">

                </td>
                <td id="pos7">

                </td>
                <td id="pos8">

                </td>
            </tr>
        </table>
        </div>
        </div>
        <div>
            <button id="new_game">Nueva Partida</button>
            <p id="victory"></p>
        </div>

    </div>
    <div></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const tablero =
            [document.getElementById("pos0"), document.getElementById("pos1"),
            document.getElementById("pos2"), document.getElementById("pos3"),
            document.getElementById("pos4"), document.getElementById("pos5"),
            document.getElementById("pos6"), document.getElementById("pos7"),
            document.getElementById("pos8")];
        const new_game = document.getElementById("new_game");
        const partida = [];
        function StartGame() {
            for (let i = 0; i < tablero.length; i++) {
                tablero[i].textContent = " ";
                tablero[i].classList.add("possible_move")
                partida[i] = ' ';
                document.getElementById("victory").textContent = " ";
            }
        }
          
        function make_move(pos) {
            tablero[pos].textContent = 'X';
            tablero[pos].classList.remove("possible_move");
            partida[pos] = "X";
        }
        function computer_move() {
           // Evaluate each possible move by running minimax and pick the best
           let moves = new Array(9).fill(-Infinity);
           let maxindex = -1;

           for (let i = 0; i < partida.length; i++) {
               if (partida[i] == ' ') {
                   // simulate move
                   const copy = Array.from(partida);
                   copy[i] = 'O';
                   moves[i] = minimax(copy, false);
               } else {
                   moves[i] = -Infinity;
               }
           }

           // find index of maximum score
           for (let i = 0; i < moves.length; i++) {
               if (maxindex === -1 || moves[i] > moves[maxindex]) {
                   maxindex = i;
               }
           }

           // fallback: pick first empty if something went wrong
           if (maxindex === -1 || partida[maxindex] !== ' ') {
               for (let i = 0; i < partida.length; i++) {
                   if (partida[i] == ' ') { maxindex = i; break; }
               }
           }

           if (maxindex !== -1) {
               tablero[maxindex].textContent = "O";
               partida[maxindex] = 'O';
           }
           return;
        }

        function human_won(board) {
            // Use the provided board array for evaluation (do not read global partida)
            let victory = false;
            if (board[0] == 'X' && board[1] == 'X' && board[2] == 'X') { // fila 1
                victory = true;
            } else if (board[3] == 'X' && board[4] == 'X' && board[5] == 'X') { // fila 2
                victory = true;
            } else if (board[6] == 'X' && board[7] == 'X' && board[8] == 'X') { // fila 3
                victory = true;
            } else if (board[0] == 'X' && board[3] == 'X' && board[6] == 'X') { // columna 1
                victory = true;
            } else if (board[1] == 'X' && board[4] == 'X' && board[7] == 'X') { // columna 2
                victory = true;
            } else if (board[2] == 'X' && board[5] == 'X' && board[8] == 'X') { // columna 3
                victory = true;
            } else if (board[0] == 'X' && board[4] == 'X' && board[8] == 'X') { // diagonal 1
                victory = true;
            } else if (board[2] == 'X' && board[4] == 'X' && board[6] == 'X') { // diagonal 2
                victory = true;
            }
            if (victory && board === partida) {
                document.getElementById("victory").textContent = "You won";
            }
            return victory;
        }

        function computer_won(board) {
            let victory = false;
            if (board[0] == 'O' && board[1] == 'O' && board[2] == 'O') { // fila 1
                victory = true;
            } else if (board[3] == 'O' && board[4] == 'O' && board[5] == 'O') { // fila 2
                victory = true;
            } else if (board[6] == 'O' && board[7] == 'O' && board[8] == 'O') { // fila 3
                victory = true;
            } else if (board[0] == 'O' && board[3] == 'O' && board[6] == 'O') { // columna 1
                victory = true;
            } else if (board[1] == 'O' && board[4] == 'O' && board[7] == 'O') { // columna 2
                victory = true;
            } else if (board[2] == 'O' && board[5] == 'O' && board[8] == 'O') { // columna 3
                victory = true;
            } else if (board[0] == 'O' && board[4] == 'O' && board[8] == 'O') { // diagonal 1
                victory = true;
            } else if (board[2] == 'O' && board[4] == 'O' && board[6] == 'O') { // diagonal 2
                victory = true;
            }
            if (victory && board === partida) {
                document.getElementById("victory").textContent = "Game Over";
            }
            return victory;
        }
        function possible_move(pos) {
            if (partida[pos] == ' ') {
                return true;
            }
            return false;
        }

            function is_draw(board) {
                let draw = true;
                for (let i = 0; i < board.length; i++) {
                    if (board[i] == ' ') {
                        draw = false;
                        break;
                    }
                }
                if (draw && board === partida) {
                    document.getElementById("victory").textContent = "draw";
                }
                return draw;
            }

            // minimax implementation: returns 1 if computer win, -1 if human win, 0 draw
            function minimax(board, isComputerTurn) {
                if (human_won(board)) return -1;
                if (computer_won(board)) return 1;
                if (is_draw(board)) return 0;

                if (isComputerTurn) {
                    let best = -Infinity;
                    for (let i = 0; i < board.length; i++) {
                        if (board[i] == ' ') {
                            const copy = Array.from(board);
                            copy[i] = 'O';
                            const score = minimax(copy, false);
                            if (score > best) best = score;
                        }
                    }
                    return best;
                } else {
                    let best = Infinity;
                    for (let i = 0; i < board.length; i++) {
                        if (board[i] == ' ') {
                            const copy = Array.from(board);
                            copy[i] = 'X';
                            const score = minimax(copy, true);
                            if (score < best) best = score;
                        }
                    }
                    return best;
                }
            }

            function game_action(pos) {
                if (!(human_won(partida) || computer_won(partida) || is_draw(partida))) {
                    if (possible_move(pos)) {
                        make_move(pos);               
                            if (!(human_won(partida) || computer_won(partida) || is_draw(partida))) {
                                computer_move();
                                computer_won(partida);
                                is_draw(partida);
                            }
                        }
                    }
                }
            StartGame();
            for (let i = 0; i<partida.length; i++) {
                tablero[i].addEventListener("click",()=> game_action(i));
            }
            new_game.addEventListener("click",()=> StartGame());
        
        });
    </script>
{% include"footer.html" %}