<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../static/style.css">
    <title>Document</title>
    <style>
        td {

            min-width: 50px;
            min-height: 50px;
            height: 50px;
            width: 50px;
            border: 1px solid var(--black);
            text-align: center;
            font-size: 2.5rem;
        }

        div {
            text-align: center;
        }

        .posible_move:hover {
            background-color: var(--grey);
            color: var(--blue);
        }
    </style>
</head>

<body>
    <div>
        <h1>Tres en raya</h1>
        <table>
            <tr>
                <td id="pos0">

                </td>
                <td id="pos1">

                </td>
                <td id="pos2">

                </td>
            </tr>
            <tr>
                <td id="pos3">

                </td>
                <td id="pos4">

                </td>
                <td id="pos5">

                </td>
            </tr>
            <tr>
                <td id="pos6">

                </td>
                <td id="pos7">

                </td>
                <td id="pos8">

                </td>
            </tr>
        </table>
        <div>
            <button id="new_game">Nueva Partida</button>
            <p id="victory"></p>
        </div>

    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
        const tablero =
            [document.getElementById("pos0"), document.getElementById("pos1"),
            document.getElementById("pos2"), document.getElementById("pos3"),
            document.getElementById("pos4"), document.getElementById("pos5"),
            document.getElementById("pos6"), document.getElementById("pos7"),
            document.getElementById("pos8")];
        const new_game = document.getElementById("new_game");
        const partida = [];
        function StartGame() {
            for (let i = 0; i < tablero.length; i++) {
                tablero[i].textContent = " ";
                tablero[i].classList.add("possible_move")
                partida[i] = ' ';
                document.getElementById("victory").textContent = " ";
            }
        }
          
        function make_move(pos) {
            tablero[pos].textContent = 'X';
            tablero[pos].classList.remove("possible_move");
            partida[pos] = "X";
        }
        function computer_move() {
            /* temporary stupid algorithm
            for (let i = 0; i < tablero.length; i++) {
                if (partida[i] == ' ') {
                    tablero[i].textContent = "O";
                    partida[i] = 'O';
                    return;
                }

            }
            */
            
           let moves = [0,0,0,0,0,0,0,0,0];
           let maxindex=moves[0];

           for(let i =0;i<partida.length;i++){
            if (partida[i]==' ') {
                moves[i]=maximin(partida,1);
            }else{
                moves[i]=-100;
            }
           }
           for(let i=1;i<tablero.length;i++){
            if(moves[i]>maxindex)
                maxindex=moves[i];
           }
           
            tablero[maxindex].textContent = "O";
            partida[maxindex] = 'O';
            return;
        }

        function human_won(board) {
            let victory = false;
            if (partida[0] == 'X' && partida[1] == 'X' && partida[2] == 'X') { // fila 1
                victory = true;
            } else if (partida[3] == 'X' && partida[4] == 'X' && partida[5] == 'X') { // fila 2
                victory = true;
            } else if (partida[6] == 'X' && partida[7] == 'X' && partida[8] == 'X') { // fila 3
                victory = true;
            } else if (partida[0] == 'X' && partida[3] == 'X' && partida[6] == 'X') { // columna 1
                victory = true;
            } else if (partida[1] == 'X' && partida[4] == 'X' && partida[7] == 'X') { // columna 2
                victory = true;
            } else if (partida[2] == 'X' && partida[5] == 'X' && partida[8] == 'X') { // columna 3
                victory = true;
            } else if (partida[0] == 'X' && partida[4] == 'X' && partida[8] == 'X') { // diagonal 1
                victory = true;
            } else if (partida[2] == 'X' && partida[4] == 'X' && partida[6] == 'X') { // diagonal 2
                victory = true;
            }
            if (victory) {
                document.getElementById("victory").textContent = "You won";
            }
            return victory;
        }

        function computer_won(board) {
            let victory = false;
            if (partida[0] == 'O' && partida[1] == 'O' && partida[2] == 'O') { // fila 1
                victory = true;
            } else if (partida[3] == 'O' && partida[4] == 'O' && partida[5] == 'O') { // fila 2
                victory = true;
            } else if (partida[6] == 'O' && partida[7] == 'O' && partida[8] == 'O') { // fila 3
                victory = true;
            } else if (partida[0] == 'O' && partida[3] == 'O' && partida[6] == 'O') { // columna 1
                victory = true;
            } else if (partida[1] == 'O' && partida[4] == 'O' && partida[7] == 'O') { // columna 2
                victory = true;
            } else if (partida[2] == 'O' && partida[5] == 'O' && partida[8] == 'O') { // columna 3
                victory = true;
            } else if (partida[0] == 'O' && partida[4] == 'O' && partida[8] == 'O') { // diagonal 1
                victory = true;
            } else if (partida[2] == 'O' && partida[4] == 'O' && partida[6] == 'O') { // diagonal 2
                victory = true;
            }
            if (victory) {
                document.getElementById("victory").textContent = "Game Over";
            }
            return victory;
        }
           function possible_move(pos) {
                if (partida[pos] == ' ') {
                    return true;
                }
                return false;
            }

            function is_draw(board) {
                let draw = true;
                for (let i = 0; i < tablero.length; i++) {
                    if (board[i] == ' ') {
                        draw = false;
                    }

                }
                if (draw) {
                    document.getElementById("victory").textContent = "draw";
                }
                return draw
            }

            function maximin(board,depth){
                console.log(board)
                let sum = 0;
                if (human_won(board)){
                    return -1;
                } else if(computer_won(board))
                    return 1;
                else if(is_draw(board)){
                    return 0;
                }else{
                    for(let i=0;i<tablero.length;i++){
                        if (board[i]==' '){
                            copy = Array.from(partida);
                            if (depth%2==1){
                                copy[i]="O";
                                sum+=maximin(copy,depth+1);
                            }else{
                                copy[i]="X";
                                sum+=maximin(copy,depth+1);
                            }
                        }
                        if(sum!=0){
                            return sum/depth;
                        }else{
                            return 0;
                        }

                    }
                    
                }

            }

            function game_action(pos) {
                if (!(human_won(partida) || computer_won(partida) || is_draw(partida))) {
                    if (possible_move(pos)) {
                        make_move(pos);               
                            if (!(human_won(partida) || computer_won(partida) || is_draw(partida))) {
                                setTimeout(computer_move(),2000);
                                computer_won(partida);
                                is_draw(partida);
                            }
                        }
                    }
                }
            StartGame();
            for (let i = 0; i<partida.length; i++) {
                tablero[i].addEventListener("click",()=> game_action(i));
            }
            new_game.addEventListener("click",()=> StartGame());
        
        });
    </script>
</body>

</html>